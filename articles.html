<!-- ai-knowledge.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Knowora ‚Äî Recherche mondiale (Wikip√©dia + Wikidata)</title>
<style>
  body{font-family:Inter,Arial,Helvetica,sans-serif;background:#0b1220;color:#e6eef6;padding:20px}
  .container{max-width:900px;margin:0 auto}
  input{width:70%;padding:10px;border-radius:6px;border:1px solid #2b3a4a}
  button{padding:10px 14px;margin-left:8px;border-radius:6px;border:none;background:#38bdf8;color:#042028;cursor:pointer}
  .result{background:#071021;border:1px solid #234; padding:18px;border-radius:8px;margin-top:18px}
  .meta{font-size:13px;color:#9fb6c8;margin-top:8px}
  a.source{color:#7ee7ff}
  .facts{margin-top:10px;background:#06131b;padding:10px;border-radius:6px}
  .small{font-size:13px;color:#8fb0c2}
</style>
</head>
<body>
  <div class="container">
    <h1>Knowora ‚Äî Recherche mondiale</h1>
    <p>Entrez un sujet (ex. : "Elon Musk", "Ha√Øti", "Intelligence artificielle")</p>

    <div>
      <input id="q" placeholder="Rechercher..." />
      <button id="go">Rechercher</button>
    </div>

    <div id="output"></div>
  </div>

<script>
/*
  Fonctionnement :
  - recherche via l'API opensearch de Wikip√©dia (fr/en)
  - r√©cup√©ration du summary (REST) pour le premier r√©sultat
  - recherche d'entit√© Wikidata via wbsearchentities, extraction des facts si trouv√©e
  - affichage avec sources
  - cache localStorage simple
*/

const output = document.getElementById('output');
const qInput = document.getElementById('q');
const btn = document.getElementById('go');

btn.onclick = () => doSearch(qInput.value.trim());

async function doSearch(query){
  if(!query) return alert('Veuillez entrer un sujet.');
  output.innerHTML = '<p class="small">Recherche en cours‚Ä¶</p>';
  const cacheKey = 'knowora_cache_'+query.toLowerCase();
  const cached = localStorage.getItem(cacheKey);
  if(cached){
    renderResult(JSON.parse(cached));
    return;
  }

  try{
    // 1) Opensearch FR then EN
    const frSearch = await fetchOpensearch('fr', query);
    const enSearch = await fetchOpensearch('en', query);

    // prefer FR if exists, else EN, else first any
    const title = frSearch[1]?.[0] || enSearch[1]?.[0] || (frSearch[1]?.[0] || enSearch[1]?.[0]);
    if(!title){
      output.innerHTML = `<p class="small">Aucun r√©sultat trouv√© pour <b>${escapeHtml(query)}</b>.</p>`;
      return;
    }

    // 2) get summary
    const summary = await fetchWikiSummary('fr', title) || await fetchWikiSummary('en', title);
    // 3) get wikidata entity
    const wd = await searchWikidata(query);

    const result = { query, title: title, summary, wikidata: wd, fetchedAt: new Date().toISOString() };

    localStorage.setItem(cacheKey, JSON.stringify(result)); // cache
    renderResult(result);
  } catch(err){
    console.error(err);
    output.innerHTML = `<p class="small">Erreur lors de la recherche ‚Äî voir console.</p>`;
  }
}

function renderResult(res){
  let html = `<div class="result">`;
  html += `<h2>${escapeHtml(res.title || res.query)}</h2>`;
  if(res.summary){
    html += `<p>${escapeHtml(res.summary.extract || res.summary.extract_html || res.summary.display_title || '')}</p>`;
    // link
    if(res.summary.content_urls?.desktop?.page){
      html += `<div class="meta">Source : <a class="source" href="${res.summary.content_urls.desktop.page}" target="_blank">Wikip√©dia</a> ¬∑ Langue : ${escapeHtml(res.summary.lang||'fr')}</div>`;
    }
  } else {
    html += `<p class="small">R√©sum√© Wikip√©dia indisponible.</p>`;
  }

  if(res.wikidata && res.wikidata.entity){
    const ent = res.wikidata.entity;
    html += `<div class="facts"><strong>Faits (Wikidata)</strong>`;
    if(ent.labels && ent.labels.en) html += `<div class="small">Label EN: ${escapeHtml(ent.labels.en.value)}</div>`;
    if(ent.labels && ent.labels.fr) html += `<div class="small">Label FR: ${escapeHtml(ent.labels.fr.value)}</div>`;
    // show some simple props if exist
    const claims = ent.claims || {};
    const propsToShow = ['P19','P27','P570','P571','P31','P361']; // birthplace, country, died, inception, instance of, part of
    propsToShow.forEach(p => {
      if(claims[p]){
        const val = claims[p][0];
        // sometimes sitelink or datavalue
        try{
          const dv = val.mainsnak.datavalue.value;
          let txt = dv.id || dv.time || dv['text'] || (dv.label? dv.label: JSON.stringify(dv));
          html += `<div class="small">${p}: ${escapeHtml(String(txt))}</div>`;
        }catch(e){}
      }
    });
    html += `</div>`;
    // provide link
    html += `<div class="meta">Source : <a class="source" href="https://www.wikidata.org/wiki/${ent.id}" target="_blank">Wikidata</a></div>`;
  }

  html += `<div style="margin-top:12px;" class="small">Donn√©es r√©cup√©r√©es le ${new Date(res.fetchedAt).toLocaleString()}</div>`;
  html += `</div>`;

  // disclaimer & attribution
  html += `<p class="small" style="margin-top:8px">Contenu : sources publiques (Wikip√©dia / Wikidata). Licence CC BY-SA ‚Äî veuillez consulter les pages pour l‚Äôattribution compl√®te.</p>`;

  output.innerHTML = html;
}

// ---- helper functions ----

async function fetchOpensearch(lang, q){
  const url = `https://${lang}.wikipedia.org/w/api.php?action=opensearch&search=${encodeURIComponent(q)}&limit=5&origin=*`;
  const r = await fetch(url);
  return r.json(); // returns [search, titles[], descriptions[], links[]]
}

async function fetchWikiSummary(lang, title){
  // REST summary endpoint
  try{
    const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
    const r = await fetch(url, {headers: {'Accept': 'application/json'}});
    if(!r.ok) return null;
    return r.json();
  }catch(e){
    return null;
  }
}

async function searchWikidata(q){
  // wbsearchentities then get entity data
  try{
    const searchUrl = `https://www.wikidata.org/w/api.php?action=wbsearchentities&search=${encodeURIComponent(q)}&language=en&format=json&origin=*`;
    const s = await fetch(searchUrl).then(r=>r.json());
    if(!s.search || !s.search[0]) return null;
    const id = s.search[0].id; // ex Q95
    const entityUrl = `https://www.wikidata.org/wiki/Special:EntityData/${id}.json`;
    const ent = await fetch(entityUrl).then(r=>r.json());
    return { entity: ent.entities[id] };
  }catch(e){
    return null;
  }
}

function escapeHtml(s){
  if(!s) return '';
  return s.replace?.(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c]) || s;
}

</script>
  <script>
async function doSearch(query){
  if(!query) return alert('Veuillez entrer un sujet.');
  output.innerHTML = '<p class="small">Recherche en cours‚Ä¶</p>';
  const cacheKey = 'knowora_cache_'+query.toLowerCase();
  const cached = localStorage.getItem(cacheKey);
  if(cached){
    renderResult(JSON.parse(cached));
    return;
  }

  try{
    // 1) Wikip√©dia & Wikidata
    const frSearch = await fetchOpensearch('fr', query);
    const enSearch = await fetchOpensearch('en', query);
    const title = frSearch[1]?.[0] || enSearch[1]?.[0];
    const summary = await fetchWikiSummary('fr', title) || await fetchWikiSummary('en', title);
    const wd = await searchWikidata(query);

    // 2) DuckDuckGo summary
    const duck = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`).then(r=>r.json());

    // 3) NewsData.io (n√©cessite cl√© API gratuite)
    const newsKey = "TA_CLE_API_NEWDATA_IO"; // √† remplacer
    const newsUrl = `https://newsdata.io/api/1/news?apikey=${newsKey}&q=${encodeURIComponent(query)}&language=fr,en`;
    const news = await fetch(newsUrl).then(r=>r.json()).catch(()=>null);

    // 4) REST Countries (si sujet semble √™tre un pays)
    let country = null;
    if(/^[A-Za-z\s]+$/.test(query)){
      country = await fetch(`https://restcountries.com/v3.1/name/${encodeURIComponent(query)}?fullText=true`)
        .then(r=>r.json()).catch(()=>null);
    }

    const result = {query, title, summary, wikidata: wd, duck, news, country, fetchedAt:new Date().toISOString()};
    localStorage.setItem(cacheKey, JSON.stringify(result));
    renderResult(result);

  } catch(err){
    console.error(err);
    output.innerHTML = `<p class="small">Erreur lors de la recherche ‚Äî voir console.</p>`;
  }
}

function renderResult(res){
  let html = `<div class="result"><h2>${escapeHtml(res.title || res.query)}</h2>`;
  
  // Wikipedia summary
  if(res.summary){
    html += `<p>${escapeHtml(res.summary.extract)}</p>`;
    if(res.summary.content_urls)
      html += `<div class="meta">Source : <a class="source" href="${res.summary.content_urls.desktop.page}" target="_blank">Wikip√©dia</a></div>`;
  }

  // DuckDuckGo
  if(res.duck?.AbstractText){
    html += `<p>${escapeHtml(res.duck.AbstractText)}</p>`;
    html += `<div class="meta">Source : <a class="source" href="${res.duck.AbstractURL}" target="_blank">DuckDuckGo</a></div>`;
  }

  // NewsData
  if(res.news?.results?.length){
    html += `<div class="facts"><strong>Actualit√©s r√©centes</strong>`;
    res.news.results.slice(0,3).forEach(n=>{
      html += `<div class="small">üì∞ <a class="source" href="${n.link}" target="_blank">${escapeHtml(n.title)}</a></div>`;
    });
    html += `</div>`;
  }

  // Country info
  if(res.country && Array.isArray(res.country) && res.country[0]){
    const c = res.country[0];
    html += `<div class="facts"><strong>Infos pays</strong>`;
    html += `<div class="small">Capitale : ${escapeHtml(c.capital?.[0] || '‚Äî')}</div>`;
    html += `<div class="small">Population : ${c.population.toLocaleString()}</div>`;
    html += `<div class="small">R√©gion : ${escapeHtml(c.region)}</div>`;
    html += `<div class="small">Drapeau : <img src="${c.flags?.png}" width="32" /></div>`;
    html += `</div>`;
  }

  html += `<div class="meta small">Donn√©es r√©cup√©r√©es le ${new Date(res.fetchedAt).toLocaleString()}</div>`;
  html += `</div>`;
  output.innerHTML = html;
}
</script>
</body>
</html>
